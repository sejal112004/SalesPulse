{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - SalesPulse{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <h1 class="page-title">Dashboard Overview</h1>
        <p class="text-muted fs-5">Welcome back! Here's what's happening with your sales today.</p>
        {% if not has_data %}
        <div class="alert alert-info mt-3" role="alert">
            <i class="bi bi-info-circle"></i> No dataset uploaded yet. <a href="{% url 'analyzer:upload' %}" class="alert-link">Upload your sales data</a> to see real-time analytics.
        </div>
        {% endif %}
    </div>

    <!-- Dataset Selector + Advanced Filters Section -->
    {% if has_data %}
    <div class="filters-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex flex-column flex-md-row gap-3 align-items-start align-items-md-center">
                <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>Advanced Filters</h5>
                {% if datasets %}
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Dataset version:</span>
                    <form method="post" action="{% url 'analyzer:activate_dataset' 0 %}" id="datasetSwitchForm">
                        {% csrf_token %}
                        <select class="form-select form-select-sm" id="datasetSelector" name="dataset_id"
                                onchange="if(this.value){ this.form.action = this.value; this.form.submit(); }">
                            {% for ds in datasets %}
                            <option
                                value="{% url 'analyzer:activate_dataset' ds.id %}"
                                {% if ds.id == current_dataset_id %}selected{% endif %}
                            >
                                v{{ ds.version }} - {{ ds.name|truncatechars:25 }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
                {% endif %}
            </div>
            <div class="d-flex gap-2 align-items-center">
                {% if filters_applied.rows_filtered > 0 %}
                <span class="badge bg-info">Filtered: {{ filters_applied.rows_filtered|intcomma }} rows</span>
                {% endif %}
                <button type="button" class="btn btn-primary btn-sm" id="explainSalesBtn">
                    <i class="bi bi-robot me-1"></i>Explain My Sales
                </button>
            </div>
        </div>
        <form method="GET" id="filterForm" class="row g-3">
            <!-- Date Range Filter -->
            <div class="col-md-3">
                <label for="date_range" class="form-label"><i class="bi bi-calendar-range me-1"></i>Date Range</label>
                <select class="form-select" id="date_range" name="date_range" onchange="document.getElementById('filterForm').submit();">
                    <option value="all" {% if filters_applied.date_range == 'all' %}selected{% endif %}>All Time</option>
                    <option value="7" {% if filters_applied.date_range == '7' %}selected{% endif %}>Last 7 Days</option>
                    <option value="30" {% if filters_applied.date_range == '30' %}selected{% endif %}>Last 30 Days</option>
                    <option value="90" {% if filters_applied.date_range == '90' %}selected{% endif %}>Last 90 Days</option>
                </select>
            </div>
            
            <!-- Region Filter -->
            {% if filter_options.regions %}
            <div class="col-md-3">
                <label for="region" class="form-label"><i class="bi bi-geo-alt me-1"></i>Region</label>
                <select class="form-select" id="region" name="region" onchange="document.getElementById('filterForm').submit();">
                    <option value="">All Regions</option>
                    {% for reg in filter_options.regions %}
                    <option value="{{ reg }}" {% if filters_applied.region == reg %}selected{% endif %}>{{ reg }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <!-- Product Filter -->
            {% if filter_options.products %}
            <div class="col-md-3">
                <label for="product" class="form-label"><i class="bi bi-box-seam me-1"></i>Product</label>
                <select class="form-select" id="product" name="product" onchange="document.getElementById('filterForm').submit();">
                    <option value="">All Products</option>
                    {% for prod in filter_options.products %}
                    <option value="{{ prod }}" {% if filters_applied.product == prod %}selected{% endif %}>{{ prod }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <!-- Category Filter -->
            {% if filter_options.categories %}
            <div class="col-md-3">
                <label for="category" class="form-label"><i class="bi bi-tags me-1"></i>Category</label>
                <select class="form-select" id="category" name="category" onchange="document.getElementById('filterForm').submit();">
                    <option value="">All Categories</option>
                    {% for cat in filter_options.categories %}
                    <option value="{{ cat }}" {% if filters_applied.category == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <!-- Clear Filters Button -->
            <div class="col-12">
                <a href="{% url 'analyzer:dashboard' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x-circle me-1"></i>Clear All Filters
                </a>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- AI Sales Explanation Card -->
    <div class="row mb-4" id="salesExplanationCard" style="display: none;">
        <div class="col-12">
            <div class="explanation-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="mb-1">
                            <i class="bi bi-lightbulb-fill text-warning me-2"></i>
                            Sales Insights
                        </h5>
                        <p class="text-muted mb-0 small">AI-powered analysis of your sales performance</p>
                    </div>
                    <button type="button" class="btn-close" id="closeExplanationBtn" aria-label="Close"></button>
                </div>
                <div id="salesExplanationContent">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Analyzing your sales data...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards - Row 1 -->
    <div class="row g-3 mb-3">
        <div class="col-lg-3 col-md-6">
            <div class="metric-card bg-primary">
                <div class="d-flex justify-content-between align-items-start w-100">
                    <div class="flex-grow-1">
                        <p class="metric-label mb-1">Total Revenue</p>
                        <h3 class="metric-value">₹{{ total_revenue|floatformat:0|intcomma }}</h3>
                        {% if revenue_comparison %}
                        <div class="mt-1 small">
                            {% if revenue_comparison.direction == 'increase' %}
                            <span class="{% if revenue_comparison.is_significant %}text-success fw-semibold{% else %}text-success{% endif %}">
                                ↑ vs last dataset: +₹{{ revenue_comparison.abs_diff|floatformat:0|intcomma }}
                                ({{ revenue_comparison.pct_change|floatformat:1 }}%)
                            </span>
                            {% elif revenue_comparison.direction == 'decrease' %}
                            <span class="{% if revenue_comparison.is_significant %}text-danger fw-semibold{% else %}text-danger{% endif %}">
                                ↓ vs last dataset: ₹{{ revenue_comparison.abs_diff|floatformat:0|intcomma }}
                                ({{ revenue_comparison.pct_change|floatformat:1 }}%)
                            </span>
                            {% else %}
                            <span class="text-light">No change vs last dataset</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="growth-indicator mt-2">
                            {% if revenue_growth >= 0 %}
                            <span class="growth-text text-success">
                                <i class="bi bi-arrow-up-circle-fill"></i> +{{ revenue_growth|floatformat:1 }}% MoM
                            </span>
                            {% else %}
                            <span class="growth-text text-danger">
                                <i class="bi bi-arrow-down-circle-fill"></i> {{ revenue_growth|floatformat:1 }}% MoM
                            </span>
                            {% endif %}
                            {% if revenue_growth_yoy != 0 %}
                            <br><small class="text-light">YoY: {% if revenue_growth_yoy >= 0 %}+{% endif %}{{ revenue_growth_yoy|floatformat:1 }}%</small>
                            {% endif %}
                        </div>
                    </div>
                    <i class="bi bi-currency-rupee metric-icon"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card bg-success">
                <div class="d-flex justify-content-between align-items-start w-100">
                    <div class="flex-grow-1">
                        <p class="metric-label mb-1">Total Orders</p>
                        <h3 class="metric-value">{{ total_orders|intcomma }}</h3>
                        {% if orders_comparison %}
                        <div class="mt-1 small">
                            {% if orders_comparison.direction == 'increase' %}
                            <span class="{% if orders_comparison.is_significant %}text-light fw-semibold{% else %}text-light{% endif %}">
                                ↑ vs last dataset: +{{ orders_comparison.abs_diff|floatformat:0|intcomma }}
                                ({{ orders_comparison.pct_change|floatformat:1 }}%)
                            </span>
                            {% elif orders_comparison.direction == 'decrease' %}
                            <span class="{% if orders_comparison.is_significant %}text-light fw-semibold{% else %}text-light{% endif %}">
                                ↓ vs last dataset: {{ orders_comparison.abs_diff|floatformat:0|intcomma }}
                                ({{ orders_comparison.pct_change|floatformat:1 }}%)
                            </span>
                            {% else %}
                            <span class="text-light">No change vs last dataset</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="growth-indicator mt-2">
                            {% if orders_growth >= 0 %}
                            <span class="growth-text text-light">
                                <i class="bi bi-arrow-up-circle-fill"></i> +{{ orders_growth|floatformat:1 }}% MoM
                            </span>
                            {% else %}
                            <span class="growth-text text-light">
                                <i class="bi bi-arrow-down-circle-fill"></i> {{ orders_growth|floatformat:1 }}% MoM
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <i class="bi bi-cart-check metric-icon"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card bg-warning">
                <div class="d-flex justify-content-between align-items-start w-100">
                    <div class="flex-grow-1">
                        <p class="metric-label mb-1">Total Customers</p>
                        <h3 class="metric-value">{{ total_customers|intcomma }}</h3>
                        <div class="growth-indicator mt-2">
                            {% if customers_growth >= 0 %}
                            <span class="growth-text text-light">
                                <i class="bi bi-arrow-up-circle-fill"></i> +{{ customers_growth|floatformat:1 }}% MoM
                            </span>
                            {% else %}
                            <span class="growth-text text-light">
                                <i class="bi bi-arrow-down-circle-fill"></i> {{ customers_growth|floatformat:1 }}% MoM
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <i class="bi bi-people metric-icon"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card bg-info">
                <div class="d-flex justify-content-between align-items-start w-100">
                    <div class="flex-grow-1">
                        <p class="metric-label mb-1">Returning Customers</p>
                        <h3 class="metric-value">{{ returning_customers_pct|floatformat:1 }}%</h3>
                        <div class="growth-indicator mt-2">
                            <span class="growth-text text-light">
                                <i class="bi bi-arrow-repeat"></i> Customer Retention
                            </span>
                        </div>
                    </div>
                    <i class="bi bi-arrow-repeat metric-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards - Row 2 (New KPIs) -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="metric-card bg-gradient-purple">
                <div class="d-flex justify-content-between align-items-start w-100">
                    <div class="flex-grow-1">
                        <p class="metric-label mb-1">Top Product</p>
                        <h3 class="metric-value">{{ top_product_name|truncatechars:20 }}</h3>
                        <div class="growth-indicator mt-2">
                            <span class="growth-text text-light">
                                <i class="bi bi-trophy-fill"></i> ₹{{ top_product_revenue|floatformat:0|intcomma }}
                            </span>
                        </div>
                    </div>
                    <i class="bi bi-box-seam metric-icon"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="metric-card bg-gradient-orange">
                <div class="d-flex justify-content-between align-items-start w-100">
                    <div class="flex-grow-1">
                        <p class="metric-label mb-1">Top Region</p>
                        <h3 class="metric-value">{{ top_region_name|truncatechars:20 }}</h3>
                        <div class="growth-indicator mt-2">
                            <span class="growth-text text-light">
                                <i class="bi bi-geo-alt-fill"></i> ₹{{ top_region_revenue|floatformat:0|intcomma }}
                            </span>
                        </div>
                    </div>
                    <i class="bi bi-geo-alt metric-icon"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="metric-card bg-secondary">
                <div class="d-flex justify-content-between align-items-start w-100">
                    <div class="flex-grow-1">
                        <p class="metric-label mb-1">Active Dataset</p>
                        <h3 class="metric-value text-truncate" style="max-width: 100%;">{{ filename|truncatechars:18 }}</h3>
                        <div class="growth-indicator mt-2">
                            {% if has_data %}
                            <span class="growth-text text-light">
                                <i class="bi bi-check-circle-fill"></i> Data Loaded
                            </span>
                            {% else %}
                            <span class="growth-text text-warning">
                                <i class="bi bi-exclamation-triangle-fill"></i> No Data
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <i class="bi bi-file-earmark-spreadsheet metric-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Insights Section -->
    {% if low_stock_items and low_stock_items|length > 0 %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="inventory-card alert alert-warning border-warning">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill text-danger"></i> 
                        Inventory Insights - Low Stock Items (≤ 10 units)
                    </h4>
                    <span class="badge bg-danger">Requires Attention</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-warning">
                            <tr>
                                <th>Product Name</th>
                                <th>Current Stock</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td><strong>{{ item.product_name }}</strong></td>
                                <td>
                                    <span class="badge bg-danger fs-6">{{ item.current_stock }} units</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">Requires Attention</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Charts & Insights Row -->
    <div class="row g-4">
        <!-- Sales Trend Chart -->
        <div class="col-lg-8">
            <div class="chart-card" style="overflow: hidden;">
                <h4 class="card-title">Sales Trend (Last 12 Months)</h4>
                {% if has_data %}
                <div style="position: relative; height: 350px; max-height: 350px; overflow: hidden;">
                    <canvas id="salesTrendChart"></canvas>
                </div>
                {% else %}
                <div class="chart-placeholder">
                    <p class="text-center text-muted py-5">
                        <i class="bi bi-bar-chart-line display-4"></i><br>
                        Upload a dataset to view sales trends
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Activity / Alerts -->
        <div class="col-lg-4">
            <div class="activity-card">
                <h4 class="card-title">Recent Activity</h4>
                {% if recent_activity %}
                <ul class="activity-list">
                    {% for activity in recent_activity %}
                    <li>
                        <i class="bi bi-{{ activity.icon }}-fill text-{{ activity.icon_color }}"></i>
                        <div>
                            <strong>{{ activity.title }}</strong><br>
                            <small class="text-muted">{{ activity.description }}</small><br>
                            <small class="text-muted">{{ activity.time_ago }}</small>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center py-3">No recent activity</p>
                {% endif %}
                <a href="{% url 'analyzer:alerts' %}" class="btn btn-outline-primary w-100 mt-3">View All Alerts</a>
            </div>
        </div>
    </div>

    <!-- Top Products Table -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="table-card">
                <h4 class="card-title">Top Performing Products</h4>
                {% if top_products %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_products %}
                            <tr>
                                <td><strong>{{ product.product_name }}</strong></td>
                                <td>{{ product.category|default:"N/A" }}</td>
                                <td>{{ product.units_sold|floatformat:0|intcomma }}</td>
                                <td>₹{{ product.Revenue|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">
                    {% if has_data %}
                    No product data available. Please check your dataset columns.
                    {% else %}
                    Upload a dataset to view top products.
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    {% if has_data and sales_trend_data %}
    const salesTrendData = {{ sales_trend_data|safe }};
    const ctx = document.getElementById('salesTrendChart');
    
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: salesTrendData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return 'Revenue: ₹' + context.parsed.y.toLocaleString('en-IN');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Revenue (₹)'
                        },
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString('en-IN');
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // Explain My Sales Button Handler
    const explainBtn = document.getElementById('explainSalesBtn');
    const explanationCard = document.getElementById('salesExplanationCard');
    const explanationContent = document.getElementById('salesExplanationContent');
    const closeBtn = document.getElementById('closeExplanationBtn');

    if (explainBtn) {
        explainBtn.addEventListener('click', function() {
            // Show loading state
            explanationCard.style.display = 'block';
            explanationContent.innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Analyzing your sales data...</span>
            `;

            // Get current filter values
            const dateRange = document.getElementById('date_range')?.value || 'all';
            const region = document.getElementById('region')?.value || '';
            const product = document.getElementById('product')?.value || '';
            const category = document.getElementById('category')?.value || '';

            // Build query string
            const params = new URLSearchParams();
            if (dateRange !== 'all') params.append('date_range', dateRange);
            if (region) params.append('region', region);
            if (product) params.append('product', product);
            if (category) params.append('category', category);

            // Make AJAX request
            fetch(`{% url 'analyzer:explain_sales' %}?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    explanationContent.innerHTML = `
                        <div class="explanation-text">
                            <p class="mb-0 fs-6">${data.summary}</p>
                        </div>
                    `;
                } else {
                    explanationContent.innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>${data.summary}
                        </div>
                    `;
                }
            })
            .catch(error => {
                explanationContent.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-x-circle me-2"></i>Error generating explanation. Please try again.
                    </div>
                `;
                console.error('Error:', error);
            });
        });
    }

    // Close explanation card
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            explanationCard.style.display = 'none';
        });
    }
});
</script>
{% endblock %}